# آرمین سافت - فایل .htaccess اصلی
# تنظیمات پیشرفته با تمرکز بر امنیت، عملکرد و سازگاری با برنامه‌های React SPA
# آخرین به‌روزرسانی: 20/04/2025

# ----------------------------------------------------------------------
# | تنظیمات پایه و سازگاری                                              |
# ----------------------------------------------------------------------
<IfModule mod_headers.c>
    # اطمینان از استفاده از کدگذاری UTF-8 برای انواع مختلف فایل
    AddDefaultCharset utf-8
    
    # محافظت از هدرهای حساس
    Header always unset X-Powered-By
    Header unset X-Powered-By
    
    # جلوگیری از اسنیفینگ MIME
    Header always set X-Content-Type-Options "nosniff"
</IfModule>

# ----------------------------------------------------------------------
# | تنظیمات امنیتی                                                     |
# ----------------------------------------------------------------------

# محافظت در برابر حملات XSS (Cross-Site Scripting)
<IfModule mod_headers.c>
    Header set X-XSS-Protection "1; mode=block"
</IfModule>

# محافظت در برابر Clickjacking
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
</IfModule>

# فعال‌سازی Content Security Policy (CSP)
<IfModule mod_headers.c>
    # تنظیمات CSP با مجوزهای محدود برای منابع
    Header always set Content-Security-Policy "default-src 'self'; \
      script-src 'self' 'unsafe-inline' https://cdn.gpteng.co https://fonts.googleapis.com https://fonts.gstatic.com https://trustseal.enamad.ir https://www.zarinpal.com; \
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; \
      img-src 'self' data: https://lovable.dev blob: https://Trustseal.eNamad.ir; \
      font-src 'self' https://fonts.gstatic.com data:; \
      connect-src 'self' https://api.armin-soft.ir; \
      frame-src 'self' https://trustseal.enamad.ir https://www.zarinpal.com; \
      object-src 'none'; \
      base-uri 'none'; \
      form-action 'self'; \
      frame-ancestors 'self'; \
      upgrade-insecure-requests;"
</IfModule>

# سیاست‌های حفظ حریم خصوصی با Referrer Policy
<IfModule mod_headers.c>
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# غیرفعال کردن نمایش فهرست دایرکتوری‌ها
Options -Indexes

# محدود کردن دسترسی به فایل‌های حساس
<FilesMatch "(^#.*#|\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])|~)$">
    Require all denied
</FilesMatch>

# محدود کردن دسترسی به دایرکتوری‌های دات
<DirectoryMatch "^\.|\/\.">
    Require all denied
</DirectoryMatch>

# جلوگیری از دسترسی به فایل‌های dotfiles
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_URI} "!(^|/)\.well-known/([^./]+./?)+$" [NC]
    RewriteCond %{SCRIPT_FILENAME} -d [OR]
    RewriteCond %{SCRIPT_FILENAME} -f
    RewriteRule "(^|/)\." - [F]
</IfModule>

# ----------------------------------------------------------------------
# | تنظیمات فشرده‌سازی و کش‌سازی                                         |
# ----------------------------------------------------------------------

# فعال‌سازی GZIP فشرده‌سازی
<IfModule mod_deflate.c>
    <IfModule mod_filter.c>
        AddOutputFilterByType DEFLATE "application/javascript" \
                                      "application/json" \
                                      "application/manifest+json" \
                                      "application/xml" \
                                      "font/otf" \
                                      "image/svg+xml" \
                                      "text/css" \
                                      "text/html" \
                                      "text/javascript" \
                                      "text/plain" \
                                      "text/xml"
    </IfModule>
</IfModule>

# تنظیمات کش برای انواع مختلف فایل
<IfModule mod_expires.c>
    ExpiresActive on
    ExpiresDefault                                      "access plus 1 month"

    # CSS
    ExpiresByType text/css                              "access plus 1 year"

    # Data
    ExpiresByType application/atom+xml                  "access plus 1 hour"
    ExpiresByType application/rdf+xml                   "access plus 1 hour"
    ExpiresByType application/rss+xml                   "access plus 1 hour"
    ExpiresByType application/json                      "access plus 0 seconds"
    ExpiresByType application/xml                       "access plus 0 seconds"

    # فاویکون (غیر از تصویر واقعی)
    ExpiresByType image/x-icon                          "access plus 1 week"

    # HTML
    ExpiresByType text/html                             "access plus 0 seconds"

    # JavaScript
    ExpiresByType application/javascript                "access plus 1 year"
    ExpiresByType text/javascript                       "access plus 1 year"

    # Media
    ExpiresByType audio/*                               "access plus 1 month"
    ExpiresByType image/avif                            "access plus 1 month"
    ExpiresByType image/gif                             "access plus 1 month"
    ExpiresByType image/jpeg                            "access plus 1 month"
    ExpiresByType image/png                             "access plus 1 month"
    ExpiresByType image/svg+xml                         "access plus 1 month"
    ExpiresByType image/webp                            "access plus 1 month"
    ExpiresByType video/*                               "access plus 1 month"

    # فونت‌ها
    ExpiresByType font/woff                             "access plus 1 month"
    ExpiresByType font/woff2                            "access plus 1 month"
    ExpiresByType application/font-woff                 "access plus 1 month"
    ExpiresByType application/font-woff2                "access plus 1 month"
    ExpiresByType font/ttf                              "access plus 1 month"
    ExpiresByType font/otf                              "access plus 1 month"
    ExpiresByType application/vnd.ms-fontobject         "access plus 1 month"
</IfModule>

# هدرهای کش برای افزایش کارایی
<IfModule mod_headers.c>
    # اجازه کش برای فایل‌های استاتیک
    <FilesMatch "\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|otf)$">
        Header set Cache-Control "max-age=31536000, public"
    </FilesMatch>
    
    # جلوگیری از کش برای فایل‌های HTML و JSON
    <FilesMatch "\.(html|json)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# ----------------------------------------------------------------------
# | قوانین Rewrite برای SPA                                            |
# ----------------------------------------------------------------------

# فعال‌سازی موتور Rewrite
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # اگر فایل یا دایرکتوری واقعی وجود دارد، آن را استفاده کن
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    
    # به استثنای دایرکتوری Assets و فایل‌هایی که وجود دارند
    RewriteCond %{REQUEST_URI} !^/Assets/
    RewriteCond %{REQUEST_URI} !\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|otf)$
    
    # همه درخواست‌ها را به index.html هدایت کن (برای React Router)
    RewriteRule ^ index.html [L]
</IfModule>

# ----------------------------------------------------------------------
# | سایر تنظیمات                                                       |
# ----------------------------------------------------------------------

# اجباری کردن HTTPS
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</IfModule>

# هدرهای CORS
<IfModule mod_headers.c>
    <FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|font.css|css|js)$">
        Header set Access-Control-Allow-Origin "*.armin-soft.ir"
    </FilesMatch>
</IfModule>

# حذف www از URL
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
    RewriteRule ^ https://%1%{REQUEST_URI} [R=301,L]
</IfModule>

# ----------------------------------------------------------------------
# | تنظیمات پیشرفته فایل‌های رسانه‌ای                                   |
# ----------------------------------------------------------------------

# استفاده از FancyIndexing برای دایرکتوری‌های مجاز
<IfModule mod_autoindex.c>
    Options -Indexes
    IndexOptions FancyIndexing VersionSort HTMLTable NameWidth=* DescriptionWidth=* SuppressHTMLPreamble
    IndexIgnore *.bak *.sw? *~ .DS_Store .htaccess .ftpquota .git node_modules dist
</IfModule>

# ----------------------------------------------------------------------
# | تنظیمات امنیتی سرور                                                |
# ----------------------------------------------------------------------

# محافظت در برابر حملات SQL injection
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2})
    RewriteRule .* index.php [F,L]
</IfModule>

# محافظت در برابر حملات تزریق فایل
<FilesMatch "(?i)\.(php|phtml|php3|php4|php5|php7|phps|phar)$">
    Require all denied
</FilesMatch>

# محافظت از فایل‌های حیاتی
<FilesMatch "^(composer\.json|package\.json|package-lock\.json|\.env.*|webpack\.config\.js|vite\.config\.js)$">
    Require all denied
</FilesMatch>

# محدود کردن متدهای HTTP
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|OPTIONS|HEAD) 
    RewriteRule .* - [F]
</IfModule>

# هدرهای امنیتی پیشرفته
<IfModule mod_headers.c>
    # هدر Strict-Transport-Security برای تحمیل HTTPS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # تنظیم هدر پرمیشن‌ها برای API های پیشرفته
    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=(self), accelerometer=(), autoplay=(), display-capture=(), document-domain=(), encrypted-media=(), fullscreen=*, gyroscope=(), magnetometer=(), midi=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=()"
</IfModule>

# ----------------------------------------------------------------------
# | بهینه‌سازی عملکرد                                                   |
# ----------------------------------------------------------------------

# تنظیم KeepAlive
<IfModule mod_filter.c>
    <IfModule mpm_worker_module>
        KeepAlive On
        MaxKeepAliveRequests 100
        KeepAliveTimeout 5
    </IfModule>
</IfModule>

# کاهش زمان پاسخ‌دهی با استفاده از تکنیک ETags
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# ----------------------------------------------------------------------
# | بخش تنظیمات مخصوص SPA ری‌اکت                                      |
# ----------------------------------------------------------------------

# بازنویسی مسیرهای SPA برای React Router
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # هدایت مسیرهای معمول به صفحه اصلی
    RewriteRule ^Home(/.*)?$ / [R=301,L]
    
    # تمام مسیرها برای React Router
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.html [L]
</IfModule>

# پایان فایل .htaccess
